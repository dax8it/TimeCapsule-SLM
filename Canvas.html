<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>p5.js + Monaco + Babel Live Editor (Fixed)</title>
  <style>
    body { margin:0; display:flex; height:100vh; overflow:hidden; }
    #editor { width:50%; height:100%; }
    #canvas { width:50%; height:100%; background:#111; }
    #controls {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:10;
    }
    #runBtn { padding:8px 16px; font-size:16px; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="runBtn">Draw</button>
  </div>
  <div id="editor"></div>
  <div id="canvas"></div>

  <!-- 1) Babel standalone for ES6â†’ES5 -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- 2) p5.js runtime -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <!-- 3) Monaco Editor loader -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs/loader.js"></script>

  <script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs' } });

    let editorInstance, currentP5;

    require(['vs/editor/editor.main'], () => {
      // Initialize Monaco with your fish one-liner
      editorInstance = monaco.editor.create(
        document.getElementById('editor'), {
          value: [
            'a=(x,y,d=mag(k=(4+cos(y))*cos(x/4),e=y/8-20))=>point((q=sin(k*3)+sin(y/19+9)*k*(6+sin(e*14-d)))*cos(d/8+t/4)+50*cos(c=d-t)+200,q*sin(c)+d*7*sin(c/4)+200)',
            't=0,draw=$=>{t||createCanvas(w=400,w);background(9);stroke(w,116);for(t+=PI/120,i=1e4;i--;)a(i,i/235)}'
          ].join('\n'),
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 16
      });

      // Runner: execute user code in p5 context
      function runSketch(src) {
        if (currentP5) currentP5.remove();

        try {
          console.log('Starting sketch with code:', src);
          
          // Create p5 instance and execute the user's code
          currentP5 = new p5((p) => {
            
            // Make p5 functions available in global scope for user code
            const p5Functions = ['createCanvas', 'background', 'stroke', 'point', 'sin', 'cos', 'mag', 'noise', 'noFill', 'arc', 'fill', 'noStroke', 'strokeWeight', 'ellipse', 'rect', 'line', 'triangle', 'quad', 'bezier', 'curve'];
            
            p5Functions.forEach(fn => {
              if (p[fn]) {
                window[fn] = p[fn].bind(p);
              }
            });
            
            // Constants
            window.PI = p.PI;
            window.TWO_PI = p.TWO_PI;
            window.HALF_PI = p.HALF_PI;
            window.PIE = p.PIE;
            window.CHORD = p.CHORD;
            window.OPEN = p.OPEN;
            
            // Common variables
            window.w = 400;
            window.W = 720;
            
            try {
              // Execute user code directly
              eval(src);
              
              // If draw function was created globally, use it
              if (window.draw && typeof window.draw === 'function') {
                p.draw = window.draw;
                console.log('Using global draw function');
              }
              
              console.log('User code executed successfully');
              
            } catch (evalError) {
              console.error('Error executing user code:', evalError);
              // Fallback to a simple sketch
              p.setup = function() {
                p.createCanvas(400, 400);
                p.background(50);
              };
              p.draw = function() {
                p.stroke(255);
                p.text('Code Error: Check Console', 10, 20);
              };
            }
            
          }, 'canvas');
          
          console.log('p5 instance created');
        } catch (error) {
          console.error('Error running sketch:', error);
        }
      }

      // Wire Draw button
      document.getElementById('runBtn').addEventListener('click', () => {
        console.log('Draw clicked');
        runSketch(editorInstance.getValue());
      });
    });
  </script>
</body>
</html>
