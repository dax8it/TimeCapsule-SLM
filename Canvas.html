<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Content Security Policy - Fallback for local development and non-Amplify deployments -->
  <!-- Note: Amplify server headers take precedence when deployed -->
  <meta http-equiv="Content-Security-Policy" content="
    script-src 'self' 'unsafe-eval' 'unsafe-inline' https: data: blob:;
    style-src 'self' 'unsafe-inline' https: data:;
    connect-src 'self' https: wss:;
    img-src 'self' data: https: blob:;
    font-src 'self' data: https:;
    worker-src 'self' blob: data:;
    object-src 'none';
  ">
  <title>SketchPad-SLM - Live p5.js Editor</title>
  <link rel="icon" type="image/png" href="lib/Media/SketchPad-SLM.png">
  <link rel="shortcut icon" type="image/png" href="lib/Media/SketchPad-SLM.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh; 
      overflow: hidden;
    }
    
    .container {
      display: grid;
      grid-template-columns: 250px 1fr 2fr;
      grid-template-rows: 120px 1fr;
      height: 100vh;
      gap: 10px;
      padding: 10px;
      position: relative;
    }
    
    .header {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      background: linear-gradient(45deg, #fff, #f0f8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .controls-panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      color: white;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      overflow-y: auto;
    }
    
    .controls-panel h3 {
      margin-bottom: 20px;
      font-size: 18px;
      color: #fff;
      text-align: center;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .btn {
      width: 100%;
      padding: 12px 16px;
      margin: 8px 0;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.primary {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .btn.primary:hover {
      box-shadow: 0 8px 25px rgba(250, 112, 154, 0.6);
    }
    
    .btn.secondary {
      background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
      box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);
    }
    
    select, input[type="file"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    
    select option {
      background: #333;
      color: white;
    }
    
    .editor-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .editor-container.expanded {
      grid-column: 2 / -1;
      z-index: 100;
    }
    
    .editor-container.minimized {
      height: 60px;
      overflow: hidden;
    }
    
    .editor-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .editor-controls {
      display: flex;
      gap: 8px;
    }
    
    .editor-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .editor-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }
    
    #editor { 
      flex: 1;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .canvas-container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .canvas-container.hidden {
      display: none;
    }
    
    .canvas-header {
      color: white;
      margin-bottom: 10px;
      font-weight: 600;
      text-align: center;
    }
    
    #canvas { 
      flex: 1;
      background: #111; 
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .status-bar {
      background: rgba(0, 0, 0, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .hidden {
      display: none;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* Logo hover effect */
    .header img:hover {
      transform: scale(1.05) rotate(2deg);
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5)) brightness(1.2);
      border-color: rgba(255,255,255,0.5);
    }
    
    /* Floating AI Panel (Cursor-style) */
    .ai-floating-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.18);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .ai-floating-panel.minimized {
      height: 60px;
      width: 300px;
    }
    
    .ai-floating-panel.hidden {
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
    }
    
    /* AI Toggle Button (always visible) */
    .ai-toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
      transition: all 0.3s ease;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(79, 172, 254, 0.6);
    }
    
    .ai-toggle-btn.active {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 20px rgba(250, 112, 154, 0.4);
    }
    
    .ai-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      color: white;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .ai-panel-controls {
      display: flex;
      gap: 8px;
    }
    
    .panel-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .panel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .ai-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
    }
    
    .ai-content.minimized {
      display: none;
    }
    
    .chat-history {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      min-height: 150px;
    }
    
    .ai-input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .ai-prompt-input {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }
    
    .ai-prompt-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-actions {
      display: flex;
      gap: 8px;
    }
    
    .ai-btn {
      flex: 1;
      padding: 10px 16px;
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .ai-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }
    
    .ai-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-btn.secondary {
      background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .chat-message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .chat-message.user {
      background: rgba(79, 172, 254, 0.2);
      color: #e6f3ff;
      margin-left: 20px;
    }
    
    .chat-message.ai {
      background: rgba(250, 112, 154, 0.2);
      color: #ffe6f0;
      margin-right: 20px;
    }
    
    .chat-message.system {
      background: rgba(168, 237, 234, 0.2);
      color: #e6fffe;
      font-style: italic;
      text-align: center;
    }
    
    .message-header {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .code-preview {
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 8px;
      border-left: 3px solid #4facfe;
    }
    
    /* Context Editor Modal */
    .context-editor-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .context-editor-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 25px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      color: white;
    }
    
    .context-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .context-editor-header h2 {
      margin: 0;
      font-size: 22px;
    }
    
    .model-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .model-selector select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
    }
    
    .context-sections {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .context-section {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .context-section h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #fff;
    }
    
    .context-input-group {
      margin-bottom: 15px;
    }
    
    .context-input-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
    }
    
    .context-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      padding: 10px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      resize: vertical;
      min-height: 80px;
    }
    
    .context-textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    .context-textarea.large {
      min-height: 120px;
    }
    
    .context-editor-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    .context-btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .context-btn.primary {
      background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
      color: white;
    }
    
    .context-btn.secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .context-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .context-template-hint {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
      font-style: italic;
    }
    
    /* User Agreement Modal */
    .user-agreement-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(15px);
    }
    
    .user-agreement-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 30px;
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .agreement-header {
      text-align: center;
      margin-bottom: 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 15px;
    }
    
    .agreement-header h2 {
      margin: 0;
      font-size: 24px;
      color: #fff;
    }
    
    .agreement-section {
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      border-left: 4px solid #fa709a;
    }
    
    .agreement-section h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #fee140;
    }
    
    .agreement-section p, .agreement-section ul {
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .agreement-section ul {
      padding-left: 20px;
    }
    
    .agreement-section li {
      margin: 5px 0;
    }
    
    .warning-box {
      background: rgba(255, 69, 0, 0.2);
      border: 2px solid rgba(255, 69, 0, 0.5);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .warning-box h4 {
      margin: 0 0 8px 0;
      color: #ff6b35;
      font-size: 16px;
    }
    
    .agreement-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .agreement-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .agreement-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 25px;">
        <img src="lib/Media/SketchPad-SLM.png" alt="SketchPad-SLM" style="width: 160px; height: 160px; object-fit: contain; filter: drop-shadow(0 8px 16px rgba(0,0,0,0.5)) brightness(1.1); border-radius: 16px; background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)); padding: 16px; border: 3px solid rgba(255,255,255,0.3); transition: all 0.3s ease;">
        <div style="display: flex; flex-direction: column;">
          <h1 style="margin: 0; font-size: 28px; font-weight: 700;">SketchPad-SLM</h1>
          <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 2px;">Creative Coding Studio</div>
        </div>
      </div>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 20px;">
        <!-- FireHacker Attribution -->
        <a href="https://x.com/thefirehacker" target="_blank" class="firehacker-link" style="
          color: rgba(255,255,255,0.9); 
          text-decoration: none; 
          display: flex; 
          flex-direction: column; 
          align-items: center; 
          gap: 4px; 
          padding: 8px 10px;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 10px;
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
          min-width: 60px;
        " 
        onmouseover="
          this.style.transform='translateY(-2px) scale(1.05)'; 
          this.style.background='rgba(255,255,255,0.15)';
          this.style.borderColor='rgba(255,255,255,0.3)';
          this.style.boxShadow='0 8px 30px rgba(0,0,0,0.25)';
          this.style.color='white';
          this.querySelector('.wizard-shimmer').style.left='100%';
        " 
        onmouseout="
          this.style.transform='translateY(0) scale(1)'; 
          this.style.background='rgba(255,255,255,0.08)';
          this.style.borderColor='rgba(255,255,255,0.15)';
          this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)';
          this.style.color='rgba(255,255,255,0.9)';
          this.querySelector('.wizard-shimmer').style.left='-100%';
        ">
          <img src="lib/Media/Firehacker_Wizard01.jpg" alt="FireHacker" style="
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            object-fit: cover;
            filter: drop-shadow(0 3px 8px rgba(0,0,0,0.4));
            transition: all 0.3s ease;
          ">
          <span style="
            font-size: 9px; 
            font-weight: 700; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          ">FireHacker</span>
          <div style="
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,165,0,0.2), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
          " class="wizard-shimmer"></div>
        </a>
        
        <a href="https://github.com/thefirehacker/SketchPad-SLM" target="_blank" class="github-link" style="
          color: rgba(255,255,255,0.9); 
          text-decoration: none; 
          display: flex; 
          flex-direction: column; 
          align-items: center; 
          gap: 4px; 
          padding: 10px 12px;
          background: rgba(255,255,255,0.08);
          border: 1px solid rgba(255,255,255,0.15);
          border-radius: 10px;
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
          min-width: 70px;
        " 
        onmouseover="
          this.style.transform='translateY(-2px) scale(1.05)'; 
          this.style.background='rgba(255,255,255,0.15)';
          this.style.borderColor='rgba(255,255,255,0.3)';
          this.style.boxShadow='0 8px 30px rgba(0,0,0,0.25)';
          this.style.color='white';
          this.querySelector('.shimmer').style.left='100%';
        " 
        onmouseout="
          this.style.transform='translateY(0) scale(1)'; 
          this.style.background='rgba(255,255,255,0.08)';
          this.style.borderColor='rgba(255,255,255,0.15)';
          this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)';
          this.style.color='rgba(255,255,255,0.9)';
          this.querySelector('.shimmer').style.left='-100%';
        ">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="
            filter: drop-shadow(0 3px 8px rgba(0,0,0,0.4));
            transition: all 0.3s ease;
          ">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.30.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          <span style="
            font-size: 10px; 
            font-weight: 700; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
            background: linear-gradient(45deg, #fff, #f0f8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          ">GitHub</span>
          <div style="
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
            pointer-events: none;
          " class="shimmer"></div>
        </a>
        <div style="
          color: rgba(255,255,255,0.85); 
          font-size: 16px; 
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        ">
          <span style="font-size: 20px;">🤖</span>
          <span>AI Integration</span>
        </div>
      </div>
    </div>
    
    <div class="controls-panel">
      <h3>🎮 Controls</h3>
      
      <div class="control-group">
        <button id="runBtn" class="btn primary">▶️ Draw</button>
      </div>
      
      <div class="control-group">
        <label>📁 Load Design:</label>
        <select id="designSelect">
          <option value="">Choose a design...</option>
          <option value="fish">🐟 Fish Animation</option>
          <option value="rabbit">🐰 Rabbit Bounce</option>
          <option value="spiral">🌀 Rainbow Spiral</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>📂 File Operations:</label>
        <input type="file" id="fileInput" accept=".js" class="hidden">
        <button id="loadFileBtn" class="btn secondary">📁 Load JS File</button>
        <button id="saveFileBtn" class="btn secondary">💾 Save JS File</button>
      </div>
      

      
      <div class="control-group">
        <label>🎯 Quick Actions:</label>
        <button id="clearBtn" class="btn">🗑️ Clear Canvas</button>
        <button id="resetBtn" class="btn">🔄 Reset Code</button>
      </div>
      
      <div class="status-bar" id="statusBar">
        Ready to create amazing p5.js art! 🚀
      </div>
      
      <!-- Usage Agreement & Terms Section -->
      <div class="control-group" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
        <button id="agreementStatusBtn" class="btn secondary" style="padding: 8px 12px; font-size: 12px; cursor: pointer;">
          📋 Usage Agreement & Terms
        </button>
        <div id="agreementStatus" style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 5px; text-align: center;">
          Status: Not Reviewed
        </div>
      </div>
      
      <!-- Creator Attribution -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center;">
        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 5px;">
          Created by
        </div>
        <a href="https://x.com/thefirehacker" target="_blank" style="
          color: rgba(255,255,255,0.8); 
          text-decoration: none; 
          font-size: 12px; 
          font-weight: 600;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 4px 8px;
          border-radius: 6px;
          background: rgba(255,255,255,0.05);
          border: 1px solid rgba(255,255,255,0.1);
          transition: all 0.3s ease;
        " 
        onmouseover="
          this.style.background='rgba(255,255,255,0.1)'; 
          this.style.borderColor='rgba(255,255,255,0.2)';
          this.style.color='white';
          this.style.transform='translateY(-1px)';
        " 
        onmouseout="
          this.style.background='rgba(255,255,255,0.05)'; 
          this.style.borderColor='rgba(255,255,255,0.1)';
          this.style.color='rgba(255,255,255,0.8)';
          this.style.transform='translateY(0)';
        ">
          🧙‍♂️ FireHacker
        </a>
      </div>
      
      <!-- API Key Section (hidden by default) -->
      <div class="control-group" id="apiKeySection" style="display: none; margin-top: 15px;">
        <label>🔑 API Configuration:</label>
        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0;">
          <input type="text" id="openaiApiKey" placeholder="OpenAI_API_KEY" 
                 style="flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                        border-radius: 6px; color: white; font-size: 12px;" type="password">
          <button id="toggleApiKeyVisibility" class="editor-btn" title="Toggle API Key Visibility" 
                  style="min-width: 35px; padding: 6px;">👁️</button>
        </div>
        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 5px;">
          API key is stored for this session only. Not saved permanently.
        </div>
      </div>
    </div>
    
    <div class="editor-container" id="editorContainer">
      <div class="editor-header">
        <span>📝 Code Editor</span>
        <div class="editor-controls">
          <button class="editor-btn" id="copyCodeBtn" title="Copy Code">📄</button>
          <button class="editor-btn" id="minimizeEditorBtn" title="Minimize Editor">−</button>
          <button class="editor-btn" id="expandEditorBtn" title="Expand Editor">⤢</button>
        </div>
      </div>
      <div id="editor"></div>
    </div>
    
    <div class="canvas-container">
      <div class="canvas-header">🖼️ Canvas Output</div>
      <div id="canvas"></div>
    </div>
  </div>

  <!-- Floating AI Toggle Button -->
  <button class="ai-toggle-btn" id="aiToggleBtn">🤖</button>

  <!-- Floating AI Panel -->
  <div class="ai-floating-panel hidden" id="aiFloatingPanel">
    <div class="ai-panel-header">
      <span>🤖 AI Assistant</span>
      <div class="ai-panel-controls">
        <button class="panel-btn" id="minimizeBtn">−</button>
        <button class="panel-btn" id="closeBtn">×</button>
      </div>
    </div>
    
    <div class="ai-content" id="aiContent">
      <div class="ai-status-bar">
        <div id="aiStatus">AI: Not connected</div>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
          <button id="chatModeBtn" class="panel-btn">🎨 Creative Mode</button>
          <button id="contextBtn" class="panel-btn">⚙️ Context</button>
          <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; color: rgba(255,255,255,0.8);">
            <input type="checkbox" id="apiModeToggle" style="margin: 0;"> API
          </label>
          <button id="initAIBtn" class="panel-btn">🔌 Connect</button>
        </div>
      </div>
      
      <div class="chat-history" id="chatHistory">
        <div class="chat-message system">
          <div class="message-header">⚙️ System</div>
          Welcome to AI-powered creative coding! Connect AI and start chatting to generate amazing p5.js art.
        </div>
      </div>
      
      <div class="ai-input-section">
        <textarea 
          id="aiPrompt" 
          class="ai-prompt-input"
          placeholder="Describe what you want to create... e.g., 'colorful spinning triangles' or 'particle system with gravity'"
        ></textarea>
        <div class="ai-actions">
          <button id="generateBtn" class="ai-btn" disabled>✨ Generate Code</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration and Analytics -->
  <script src="config.js"></script>

  <!-- Dependencies -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs/loader.js"></script>

  <script>
    // Initialize Google Analytics
    document.addEventListener('DOMContentLoaded', function() {
      if (window.AppConfig) {
        window.AppConfig.initializeGA4();
        
        // Track initial page view
        window.AppConfig.trackPageView('SketchPad-SLM Canvas', window.location.href);
      }
    });

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs' } });

    let editorInstance, currentP5, aiSession = null;
    let chatHistory = [];
    let chatMode = 'creative'; // 'creative' or 'general'
    let apiMode = false; // false = local LLM, true = API mode
    let openaiApiKey = ''; // Session API key
    let userAgreementAccepted = false; // Track if user accepted terms
    let agreementTimestamp = null; // Track when user accepted agreement
    let agreementReminderTimer = null; // Timer for first reminder (2 minutes)
    let agreementRecurringTimer = null; // Timer for recurring reminders (30 seconds)
    let agreementModalOpen = false; // Track if agreement modal is currently open
    let pendingAIInitialization = false; // Track if user explicitly wants to initialize AI
    
    // Context Templates (customizable by user)
    let customContexts = {
      general: {
        systemPrompt: 'You are a helpful AI assistant. Answer questions clearly and informatively.',
        userTemplate: 'Question: {prompt}\n\nAnswer this question clearly and informatively (maximum 10 lines). Be direct and helpful.'
      },
      creative: {
        systemPrompt: 'You are a helpful assistant that generates p5.js code.',
        userTemplate: `Generate p5.js code for: {prompt}

Use this exact structure:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.05
  fill(255,100,150)
  ellipse(400+sin(t)*100,300+cos(t)*100,50,50)
}

Only modify the fill() and ellipse() lines to create the requested animation. Return just the 6-line code block.`
      }
    };
    
    // Design files mapping
    const designs = {
      fish: 'lib/Designs/fish.js',
      rabbit: 'lib/Designs/rabbit.js',
      spiral: 'lib/Designs/spiral.js'
    };

    // AI System Prompt - Teaches Gemini Nano about SketchPad-SLM
    const SYSTEM_PROMPT = `You are an AI assistant for SketchPad-SLM, a creative coding studio that uses p5.js with compact JavaScript syntax.

IMPORTANT RULES:
1. Always generate COMPACT p5.js code that works in our editor
2. Use the specific syntax patterns shown below
3. Keep code concise and creative
4. Focus on visual/generative art patterns

REQUIRED CODE STRUCTURE:
- Use compact syntax: t=0,draw=_=>{...}
- Always include: t||createCanvas(w,h) for setup
- Use global variables: t (time), w/h (dimensions)
- Animation: increment t each frame
- Drawing: use p5.js functions like point(), ellipse(), stroke(), fill()

EXAMPLES OF GOOD CODE:
1. Simple animation:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0)
  t+=0.05
  fill(sin(t)*127+128,cos(t)*127+128,255)
  ellipse(w/2+sin(t)*100,h/2+cos(t)*100,50,50)
}

2. Particle system:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.02
  for(i=0;i<100;i++){
    x=w/2+sin(t+i)*i*2
    y=h/2+cos(t+i*0.1)*i*2
    fill(i*2,255-i*2,255)
    ellipse(x,y,5,5)
  }
}

AVAILABLE FUNCTIONS:
- Drawing: point(), line(), ellipse(), rect(), arc(), triangle()
- Color: fill(), stroke(), noFill(), noStroke(), background()
- Math: sin(), cos(), noise(), random(), mag(), PI, TWO_PI
- Canvas: createCanvas(), strokeWeight()

When user asks for something, generate creative, compact p5.js code that creates visual art matching their request.`;

    // Show User Agreement Modal
    function showUserAgreement() {
      // Don't show modal if one is already open
      if (agreementModalOpen) {
        console.log('⚠️ Agreement modal already open - skipping duplicate');
        return;
      }
      
      // Close any existing AI selection modals first
      const existingAIModal = document.querySelector('[style*="position: fixed"][style*="z-index: 2000"]');
      if (existingAIModal) {
        existingAIModal.remove();
        console.log('🔄 Closed existing AI modal before showing agreement');
      }
      
      // Mark modal as open
      agreementModalOpen = true;
      
      const modal = document.createElement('div');
      modal.className = 'user-agreement-modal';
      modal.id = 'userAgreementModal';
      
      modal.innerHTML = `
        <div class="user-agreement-content">
          <div class="agreement-header">
            <h2>📋 Usage Agreement & Terms</h2>
            <p style="font-size: 14px; color: rgba(255,255,255,0.8); margin: 10px 0 0 0;">
              Please review these important terms before using AI features
            </p>
          </div>
          
          <div class="agreement-section">
            <h3>🤖 AI Technology Usage</h3>
            <p>SketchPad-SLM integrates artificial intelligence for <strong>workflow automation and creative assistance</strong>. AI features include:</p>
            <ul>
              <li>Local FP16 Qwen2.5 language model for offline code generation</li>
              <li>OpenAI API integration for advanced AI capabilities</li>
              <li>Automated p5.js code generation and creative coding assistance</li>
              <li>Context-aware chat and programming help</li>
            </ul>
          </div>
          
          <div class="warning-box">
            <h4>⚠️ IMPORTANT AI ACCURACY DISCLAIMER</h4>
            <p><strong>AI is NOT a fully accurate tool.</strong> Generated code, responses, and suggestions may contain errors, bugs, or inaccuracies. All AI output should be thoroughly reviewed, tested, and validated by the end user before implementation or reliance.</p>
          </div>
          
          <div class="agreement-section">
            <h3>👤 User Responsibilities</h3>
            <p>By using AI features, you acknowledge and agree to:</p>
            <ul>
              <li><strong>Review all AI-generated content</strong> for accuracy and appropriateness</li>
              <li><strong>Test generated code</strong> before using in production environments</li>
              <li><strong>Verify AI responses</strong> against authoritative sources when needed</li>
              <li><strong>Use AI as an assistant tool</strong>, not as a replacement for human judgment</li>
              <li><strong>Comply with OpenAI's usage policies</strong> when using API features</li>
            </ul>
          </div>
          
          <div class="agreement-section">
            <h3>🛡️ Liability Limitation</h3>
            <p><strong>AIEDX Private Limited or any of its employees</strong> provides AI features "as-is" and makes no warranties regarding:</p>
            <ul>
              <li>Accuracy, completeness, or reliability of AI-generated content</li>
              <li>Suitability for any particular purpose or use case</li>
              <li>Absence of errors, bugs, or security vulnerabilities in generated code</li>
              <li>Compliance with any specific standards or requirements</li>
            </ul>
            <p><strong>AIEDX Private Limited or any of its employees shall not be liable</strong> for any direct, indirect, incidental, consequential, or punitive damages arising from or related to the use of AI features, including but not limited to:</p>
            <ul>
              <li>Data loss or corruption</li>
              <li>System failures or security breaches</li>
              <li>Business interruption or financial losses</li>
              <li>Any damages caused by reliance on AI-generated content</li>
            </ul>
          </div>
          
          <div class="agreement-section">
            <h3>🔒 Data & Privacy</h3>
            <p>When using AI features:</p>
            <ul>
              <li><strong>Local AI:</strong> Processing happens on your device, no data sent to external servers</li>
              <li><strong>API Mode:</strong> Your prompts and responses are sent to OpenAI according to their privacy policy</li>
              <li><strong>Session Data:</strong> API keys are stored temporarily in browser memory only</li>
              <li><strong>No Persistent Storage:</strong> We do not permanently store your AI interactions</li>
            </ul>
          </div>
          
          <div class="agreement-actions">
            <div class="agreement-checkbox">
              <input type="checkbox" id="agreementCheckbox">
              <label for="agreementCheckbox">I have read, understood, and agree to these terms</label>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="context-btn secondary" onclick="declineAgreement()">Decline</button>
              <button class="context-btn primary" id="acceptAgreementBtn" disabled onclick="acceptAgreement()">Accept & Continue</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Enable accept button only when checkbox is checked
      document.getElementById('agreementCheckbox').addEventListener('change', (e) => {
        document.getElementById('acceptAgreementBtn').disabled = !e.target.checked;
      });
      
      // Handle modal close when clicking outside (but keep modal persistent for legal compliance)
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          // Don't allow closing by clicking outside - user must actively accept or decline
          console.log('⚠️ Agreement must be accepted or declined - cannot close by clicking outside');
          // Prevent any background AI modal from showing
          e.stopPropagation();
          e.preventDefault();
        }
      });
    }

    // Accept User Agreement
    function acceptAgreement() {
      userAgreementAccepted = true;
      agreementTimestamp = new Date(); // Record acceptance timestamp
      
      // Stop all agreement reminders
      stopAgreementReminders();
      
      // Mark modal as closed
      agreementModalOpen = false;
      
      const modal = document.getElementById('userAgreementModal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        }, 300);
      }
      
      // Update agreement status display
      updateAgreementStatusDisplay();
      
      // Track agreement acceptance
      if (window.AppConfig) {
        window.AppConfig.trackEvent('user_agreement_accepted', 'legal', 'ai_terms');
      }
      
      // Only proceed with AI initialization if user explicitly requested it
      if (pendingAIInitialization) {
        console.log('✅ Agreement accepted - proceeding with requested AI initialization');
        pendingAIInitialization = false; // Reset flag
        showAISelectionModal();
      } else {
        console.log('✅ Agreement accepted - no AI initialization requested');
        addChatMessage('system', '✅ User Agreement accepted. You can now use AI features by clicking "Connect AI".');
      }
    }

    // Decline User Agreement
    function declineAgreement() {
      // Mark modal as closed
      agreementModalOpen = false;
      
      const modal = document.getElementById('userAgreementModal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        }, 300);
      }
      
      updateStatus('❌ AI features unavailable without agreement acceptance');
      addChatMessage('system', '❌ AI features are disabled. You must accept the User Agreement to use AI capabilities.');
      
      // Track agreement decline
      if (window.AppConfig) {
        window.AppConfig.trackEvent('user_agreement_declined', 'legal', 'ai_terms');
      }
    }

    // Update Agreement Status Display
    function updateAgreementStatusDisplay() {
      const statusDiv = document.getElementById('agreementStatus');
      const statusBtn = document.getElementById('agreementStatusBtn');
      
      if (userAgreementAccepted && agreementTimestamp) {
        const dateStr = agreementTimestamp.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        const timeStr = agreementTimestamp.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        
        statusDiv.innerHTML = `Status: ✅ Agreed<br/><span style="font-size: 10px; color: rgba(255,255,255,0.6);">${dateStr} at ${timeStr}</span>`;
        statusBtn.style.background = 'linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)';
        statusBtn.style.color = 'white';
      } else {
        statusDiv.textContent = 'Status: Not Reviewed';
        statusBtn.style.background = 'linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)';
        statusBtn.style.color = '#333';
      }
    }

    // Show Agreement from Status Button
    function showAgreementFromStatus() {
      // Track agreement view from status button
      if (window.AppConfig) {
        window.AppConfig.trackEvent('agreement_viewed_from_status', 'legal', 'status_button');
      }
      
      // This is just for review - not for AI initialization
      pendingAIInitialization = false;
      console.log('📋 Showing agreement for review (not AI initialization)');
      
      // Show the same agreement modal
      showUserAgreement();
    }

    // Start Agreement Reminder System
    function startAgreementReminders() {
      // Clear any existing timers
      stopAgreementReminders();
      
      console.log('🔔 Agreement reminder system started: 2-minute initial reminder, then 30-second recurring');
      
      // Set initial 2-minute reminder
      agreementReminderTimer = setTimeout(() => {
        if (!userAgreementAccepted && !agreementModalOpen) {
          console.log('⏰ Showing 2-minute agreement reminder (not for AI initialization)');
          // This is just a reminder - not for AI initialization
          pendingAIInitialization = false;
          showUserAgreement();
          
          // Start recurring 30-second reminders
          startRecurringReminders();
          
          // Track automatic reminder
          if (window.AppConfig) {
            window.AppConfig.trackEvent('agreement_auto_reminder', 'legal', '2_minute_reminder');
          }
        } else if (agreementModalOpen) {
          console.log('⏰ 2-minute reminder skipped - modal already open');
          // Start recurring reminders anyway since modal is open
          startRecurringReminders();
        }
      }, 120000); // 2 minutes = 120,000ms
    }

    // Start Recurring 30-second Reminders
    function startRecurringReminders() {
      // Clear any existing recurring timer
      if (agreementRecurringTimer) {
        clearInterval(agreementRecurringTimer);
      }
      
      // Set recurring 30-second reminders
      agreementRecurringTimer = setInterval(() => {
        if (!userAgreementAccepted && !agreementModalOpen) {
          console.log('🔄 Showing 30-second recurring agreement reminder (not for AI initialization)');
          // This is just a reminder - not for AI initialization
          pendingAIInitialization = false;
          showUserAgreement();
          
          // Track recurring reminder
          if (window.AppConfig) {
            window.AppConfig.trackEvent('agreement_recurring_reminder', 'legal', '30_second_reminder');
          }
        } else if (!userAgreementAccepted && agreementModalOpen) {
          console.log('🔄 30-second reminder skipped - modal already open');
        } else {
          // Stop recurring reminders if agreement accepted
          console.log('✅ Agreement accepted - stopping recurring reminders');
          clearInterval(agreementRecurringTimer);
          agreementRecurringTimer = null;
        }
      }, 30000); // 30 seconds = 30,000ms
    }

    // Stop All Agreement Reminders
    function stopAgreementReminders() {
      if (agreementReminderTimer) {
        clearTimeout(agreementReminderTimer);
        agreementReminderTimer = null;
      }
      
      if (agreementRecurringTimer) {
        clearInterval(agreementRecurringTimer);
        agreementRecurringTimer = null;
      }
    }

    // Initialize AI with Multiple Options
    async function initializeAI() {
      try {
        updateStatus('🤖 Initializing AI system...');
        document.getElementById('aiStatus').textContent = 'AI: Checking...';
        
        // Mark that user explicitly wants to initialize AI
        pendingAIInitialization = true;
        
        // Check if user has accepted agreement
        if (!userAgreementAccepted) {
          console.log('🔒 User explicitly requested AI - showing agreement first');
          showUserAgreement();
          return;
        }
        
        // Additional safety check - don't show AI modal if agreement modal is open
        if (agreementModalOpen) {
          console.log('⚠️ Agreement modal is open - deferring AI initialization');
          return;
        }
        
        // User has accepted agreement and explicitly wants AI - show selection modal
        console.log('✅ User explicitly requested AI and agreement is accepted - showing AI selection');
        pendingAIInitialization = false; // Reset flag since we're proceeding
        showAISelectionModal();
        
      } catch (error) {
        console.error('AI initialization error:', error);
        pendingAIInitialization = false; // Reset flag on error
        fallbackToTemplates();
      }
    }

    // Show AI selection modal
    function showAISelectionModal() {
      // Don't show AI modal if agreement modal is open
      if (agreementModalOpen) {
        console.log('⚠️ Agreement modal is open - cannot show AI selection modal');
        return;
      }
      
      // Don't show if user hasn't accepted agreement
      if (!userAgreementAccepted) {
        console.log('⚠️ User agreement not accepted - cannot show AI selection modal');
        showUserAgreement();
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'ai-selection-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 2000; display: flex;
        align-items: center; justify-content: center;
      `;
      
      const isApiMode = apiMode;
      
      if (isApiMode) {
        // API Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h2 style="color: white; margin-bottom: 20px; text-align: center;">🚀 Advanced API Models</h2>
            
            <div style="margin-bottom: 20px;">
              <label style="color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 10px; display: block;">Select Model:</label>
              <select id="apiModelSelect" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); 
                                                 border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; 
                                                 color: white; font-size: 14px;">
                <option value="gpt-4o-mini">GPT-4o Mini (Fast & Efficient)</option>
                <option value="gpt-4o">GPT-4o (Most Capable)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo (Balanced)</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Budget-Friendly)</option>
              </select>
            </div>
            
            <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 20px; text-align: center;">
              📝 Requires valid OpenAI API key<br/>
              💰 API usage charges apply based on your OpenAI plan
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button id="connectApiModel" class="ai-option-btn" style="flex: 1;">
                🔌 Connect API Model
              </button>
            </div>
            
            <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                    color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                    float: right; margin-top: 10px;">Cancel</button>
          </div>
        `;
      } else {
        // Local FP16 Mode Modal
        modal.innerHTML = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h2 style="color: white; margin-bottom: 20px; text-align: center;">🤖 Local FP16 Qwen2.5</h2>
            
            <div style="margin-bottom: 20px;">
              <button id="selectJanus" class="ai-option-btn">
                🚀 Load Qwen2.5-0.5B FP16 (~1GB)
              </button>
              <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 5px;">
                FP16 precision only. Maximum quality local AI. No API costs.
              </p>
            </div>
            
            <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 20px; text-align: center;">
              ⚠️ Requires WebGPU support and 2GB+ RAM<br/>
              Model cached after first download for instant future loading
            </div>
            
            <button id="closeModal" style="background: rgba(255,255,255,0.2); border: none; 
                    color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; 
                    float: right; margin-top: 10px;">Cancel</button>
          </div>
        `;
      }
      
      const style = document.createElement('style');
      style.textContent = `
        .ai-option-btn {
          width: 100%; padding: 15px; margin: 5px 0; background: rgba(255,255,255,0.1);
          border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; color: white;
          font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .ai-option-btn:hover {
          background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.5);
          transform: translateY(-2px);
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(modal);
      
      // Event listeners
      if (isApiMode) {
        document.getElementById('connectApiModel').onclick = () => {
          const selectedModel = document.getElementById('apiModelSelect').value;
          document.body.removeChild(modal);
          initializeApiModel(selectedModel);
        };
      } else {
        document.getElementById('selectJanus').onclick = () => {
          document.body.removeChild(modal);
          initializeJanus();
        };
      }
      
      document.getElementById('closeModal').onclick = () => {
        document.body.removeChild(modal);
        updateStatus('AI initialization cancelled');
        addChatMessage('system', 'AI initialization cancelled.');
      };
    }



    // Initialize API Model (OpenAI)
    async function initializeApiModel(modelName) {
      try {
        updateStatus('🚀 Connecting to OpenAI API...');
        document.getElementById('aiStatus').textContent = 'AI: Connecting to API...';
        
        // Check if API key is provided
        const apiKey = document.getElementById('openaiApiKey').value.trim();
        if (!apiKey) {
          addChatMessage('system', '❌ OpenAI API Key required. Please enter your API key in the left panel.');
          document.getElementById('aiStatus').textContent = 'AI: API Key Required ❌';
          updateStatus('❌ API Key required');
          return;
        }
        
        // Store API key for session
        openaiApiKey = apiKey;
        
        // Test API connection with a simple request
        const testResponse = await fetch('https://api.openai.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!testResponse.ok) {
          throw new Error(`API Key validation failed: ${testResponse.status} ${testResponse.statusText}`);
        }
        
        aiSession = { type: 'openai', model: modelName, apiKey: apiKey };
        document.getElementById('aiStatus').textContent = `AI: ${modelName} ✅`;
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = `🚀 ${modelName} Ready`;
        
        updateStatus(`🚀 ${modelName} connected successfully!`);
        addChatMessage('system', `🚀 ${modelName} connected! Advanced AI capabilities are now available. API usage charges apply.`);
        
        // Track API model connection
        if (window.AppConfig) {
          window.AppConfig.trackEvent('api_model_connected', 'ai_interaction', modelName);
        }
        
      } catch (error) {
        console.error('API Model initialization error:', error);
        addChatMessage('system', `❌ Failed to connect to OpenAI API: ${error.message}`);
        document.getElementById('aiStatus').textContent = 'AI: API Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ API Failed';
        updateStatus('❌ API connection failed');
      }
    }

    // Initialize Qwen2.5
    async function initializeJanus() {
      try {
        updateStatus('🚀 Loading Qwen2.5-0.5B FP16 (~1GB)...');
        document.getElementById('aiStatus').textContent = 'AI: Loading Qwen2.5 FP16...';
        
        // Check browser compatibility
        const hasFloat16 = typeof Float16Array !== 'undefined';
        if (!hasFloat16) {
          addChatMessage('system', '⚠️ Your browser lacks Float16Array support. Using q4 quantization instead of q4f16 for better compatibility.');
        }
        
        // Show loading screen
        showLoadingScreen();
        
        // Import Transformers.js
        updateLoadingProgress(10, 'Importing Transformers.js...');
        
        // Temporarily suppress verbose ONNX warnings during loading
        const originalWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          if (message.includes('VerifyEachNodeIsAssignedToAnEp') || 
              message.includes('Some nodes were not assigned') ||
              message.includes('Rerunning with verbose output')) {
            return; // Suppress these specific warnings
          }
          originalWarn.apply(console, args);
        };
        
        const { AutoTokenizer, AutoModelForCausalLM } = await import('https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.1.0');
        
        const MODEL = 'onnx-community/Qwen2.5-0.5B-Instruct-ONNX';
        
        // Load tokenizer first
        updateLoadingProgress(20, 'Loading tokenizer...');
        const tokenizer = await AutoTokenizer.from_pretrained(MODEL, {
          progress_callback: (progress) => {
            try {
              if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                const percent = 20 + (progress.progress * 30);
                const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                updateLoadingProgress(percent, `Loading tokenizer: ${fileName}`);
              }
            } catch (e) {
              console.warn('Progress callback error:', e);
            }
          }
        });
        
        // WebGPU-only loading with timeout handling
        let model;
        
        // Timeout wrapper function
        const loadWithTimeout = async (loadFn, timeoutMs, description) => {
          return Promise.race([
            loadFn(),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error(`${description} timed out after ${timeoutMs/1000}s`)), timeoutMs)
            )
          ]);
        };
        
                  try {
            updateLoadingProgress(50, 'Loading with WebGPU acceleration...');
            addChatMessage('system', '🚀 Starting WebGPU model download (~500MB). Using text-only mode to avoid vision model errors. This may take 2-5 minutes...');
          
          // Add progress timeout detection
          let lastProgress = 0;
          let progressStuckTime = Date.now();
          
                      model = await loadWithTimeout(
              () => AutoModelForCausalLM.from_pretrained(MODEL, {
                device: 'webgpu',
                dtype: 'fp16',
                progress_callback: (progress) => {
                  try {
                    if (progress && typeof progress.progress === 'number' && progress.progress >= 0 && progress.progress <= 1) {
                      const percent = 50 + (progress.progress * 45);
                      const fileName = progress.file ? progress.file.split('/').pop() : 'processing...';
                      updateLoadingProgress(percent, `Loading model (FP16): ${fileName}`);
                      
                      // Detect stuck progress
                      if (Math.abs(progress.progress - lastProgress) > 0.01) {
                        lastProgress = progress.progress;
                        progressStuckTime = Date.now();
                      } else if (Date.now() - progressStuckTime > 300000) {
                        // Progress stuck for 5 minutes for FP16
                        throw new Error('FP16 download progress stuck - likely network or memory issue');
                      }
                    }
                  } catch (e) {
                    console.warn('Progress callback error:', e);
                  }
                }
              }),
              1200000, // 20 minute timeout for FP16 (larger download)
              'FP16 WebGPU model loading'
            );
          
          addChatMessage('system', '🎉 FP16 precision loaded successfully! Maximum quality WebGPU acceleration active.');
        } catch (webgpuError) {
          console.warn('WebGPU loading failed:', webgpuError);
          
          // FP16 failed - no fallbacks, AI disabled
          console.error('FP16 WebGPU loading failed:', webgpuError);
          addChatMessage('system', '❌ FP16 model loading failed. AI is disabled. FP16 precision required.');
          document.getElementById('aiStatus').textContent = 'AI: FP16 Failed ❌';
          document.getElementById('generateBtn').disabled = true;
          document.getElementById('initAIBtn').textContent = '❌ FP16 Required';
          hideLoadingScreen();
          updateStatus('❌ FP16 model failed to load. AI disabled.');
          return;
        }
        
        updateLoadingProgress(95, 'Finalizing model setup...');
        aiSession = { type: 'qwen', model, tokenizer };
        document.getElementById('aiStatus').textContent = 'AI: Qwen2.5-0.5B (FP16) ✅';
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('initAIBtn').textContent = '🚀 Qwen2.5 FP16 Ready';
        
        // Restore console.warn
        console.warn = originalWarn;
        
        updateLoadingProgress(100, 'Model loaded successfully!');
        setTimeout(() => {
          hideLoadingScreen();
          updateStatus('🚀 Qwen2.5-0.5B (FP16) loaded successfully!');
          addChatMessage('system', '🚀 Qwen2.5-0.5B loaded in FP16 precision! Ready to generate creative p5.js code with maximum quality. This text-only model avoids all vision-related errors.');
          
          // Track successful AI loading with FP16 precision
          if (window.AppConfig) {
            window.AppConfig.trackEvent('ai_model_loaded', 'ai_interaction', 'qwen2.5_fp16_success');
          }
        }, 500);
        
      } catch (error) {
        console.error('Qwen2.5 FP16 initialization error:', error);
        
        // Restore console.warn in case of error
        if (typeof originalWarn !== 'undefined') {
          console.warn = originalWarn;
        }
        
        hideLoadingScreen();
        addChatMessage('system', `❌ Failed to load Qwen2.5 FP16: ${error.message}. AI is disabled.`);
        document.getElementById('aiStatus').textContent = 'AI: FP16 Failed ❌';
        document.getElementById('generateBtn').disabled = true;
        document.getElementById('initAIBtn').textContent = '❌ FP16 Required';
        updateStatus('❌ FP16 model failed to load. AI disabled.');
      }
    }

    // Show loading screen
    function showLoadingScreen() {
      const loadingScreen = document.createElement('div');
      loadingScreen.id = 'loadingScreen';
      loadingScreen.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 3000; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
      `;
      
              loadingScreen.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    border-radius: 20px; padding: 40px; max-width: 500px; width: 90%;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.5); text-align: center;">
          <div style="color: white; font-size: 24px; font-weight: 600; margin-bottom: 20px;">
            🚀 Loading Qwen2.5-0.5B
          </div>
          <div style="color: rgba(255,255,255,0.8); margin-bottom: 30px;">
            FP16 precision: ~1GB • Maximum quality • Cached for future use
          </div>
          
          <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 20px; 
                      margin-bottom: 15px; overflow: hidden;">
            <div id="progressBar" style="background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); 
                                        height: 100%; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          
          <div id="progressText" style="color: rgba(255,255,255,0.9); font-size: 14px;">
            Initializing...
          </div>
          <div id="progressPercent" style="color: white; font-size: 18px; font-weight: 600; margin-top: 10px;">
            0%
          </div>
        </div>
      `;
      
      document.body.appendChild(loadingScreen);
    }

    // Update loading progress
    function updateLoadingProgress(percent, message) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      
      // Validate and clamp percentage
      const validPercent = Math.max(0, Math.min(100, Math.round(percent || 0)));
      
      if (progressBar) progressBar.style.width = validPercent + '%';
      if (progressText) progressText.textContent = message || 'Loading...';
      if (progressPercent) progressPercent.textContent = validPercent + '%';
      
      // Log progress for debugging
      console.log(`Loading progress: ${validPercent}% - ${message}`);
    }

    // Hide loading screen
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transform = 'scale(0.9)';
        loadingScreen.style.transition = 'all 0.3s ease';
        setTimeout(() => {
          if (loadingScreen.parentNode) {
            loadingScreen.parentNode.removeChild(loadingScreen);
          }
        }, 300);
      }
    }

    // Fallback to templates
    function fallbackToTemplates() {
      aiSession = 'template';
      document.getElementById('aiStatus').textContent = 'AI: Smart Templates ⚡';
      document.getElementById('generateBtn').disabled = false;
      document.getElementById('initAIBtn').textContent = '⚡ Templates Ready';
      updateStatus('⚡ Smart Templates ready!');
      addChatMessage('system', '⚡ Smart Template system activated! Uses pattern matching for instant code generation. Works for: "particle explosion", "rainbow spiral", "ocean waves", "geometric patterns", etc.');
      
      // Track template fallback
      if (window.AppConfig) {
        window.AppConfig.trackEvent('ai_template_fallback', 'ai_interaction', 'template_system');
      }
    }

    // Generate code using AI (FP16 Qwen2.5 or OpenAI API)
    async function generateAICode(userPrompt) {
      if (!aiSession) {
        updateStatus('❌ AI not connected. Click "Connect AI" first.');
        return;
      }
      
      if (aiSession !== 'template' && aiSession.type !== 'qwen' && aiSession.type !== 'openai') {
        updateStatus('❌ Invalid AI session type.');
        addChatMessage('ai', 'AI session error. Please reconnect.');
        return;
      }

      try {
        // Console log user input (pretty formatted)
        console.log('%c📝 USER INPUT', 'background: #4facfe; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', userPrompt);
        
        // Add user message to chat
        addChatMessage('user', userPrompt);
        
        // Handle different chat modes
        if (chatMode === 'general') {
          return await handleGeneralChat(userPrompt);
        } else {
          return await handleCreativeChat(userPrompt);
        }
        
      } catch (error) {
        console.error('AI generation error:', error);
        updateStatus('❌ AI generation failed: ' + error.message);
        addChatMessage('ai', `Error: ${error.message}. Please try again.`);
      }
    }

    // Handle general chat (no code generation)
    async function handleGeneralChat(userPrompt) {
      updateStatus('🤖 AI is thinking...');
      
      let aiResponse = '';
      
      // AI Model handling - General conversation  
      if (aiSession.type === 'qwen') {
        try {
          // Use custom context template
          const generalPrompt = customContexts.general.userTemplate.replace('{prompt}', userPrompt);

          const messages = [
            { role: 'system', content: customContexts.general.systemPrompt },
            { role: 'user', content: generalPrompt }
          ];
          
          const textInput = aiSession.tokenizer.apply_chat_template(messages, { 
            tokenize: false, 
            add_generation_prompt: true 
          });
          
          // Log the actual formatted prompt being sent to AI
          console.log('%c🔍 ACTUAL QUERY (Qwen2.5 General)', 'background: #a8edea; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
          console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', textInput);
          
          const inputs = await aiSession.tokenizer(textInput, {
            return_tensors: 'pt',
            padding: true
          });
          
          const genParams = { 
            input_ids: inputs.input_ids,
            attention_mask: inputs.attention_mask,
            max_new_tokens: 512,
            temperature: 0.7,
            do_sample: true
          };
          
          const out = await aiSession.model.generate(genParams);
          const newTok = out.slice(null, [inputs.input_ids.dims.at(-1), null]);
          aiResponse = aiSession.tokenizer.batch_decode(newTok, { skip_special_tokens: true })[0];
          
          // Console log raw AI response before cleanup
          console.log('%c🤖 RAW AI RESPONSE (Qwen2.5 General)', 'background: #fa709a; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', aiResponse);
          
          // Clean up the response aggressively
          aiResponse = aiResponse.trim();
          
          // Remove prompt text and common AI artifacts
          aiResponse = aiResponse.replace(new RegExp(`Question: ${userPrompt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'), '');
          aiResponse = aiResponse.replace(/Answer this question with.*?factual\./gi, '');
          aiResponse = aiResponse.replace(/^(Answer:|Response:|Here's|The answer is:?)/gi, '');
          
          // Take up to 10 lines or reasonable paragraph length
          const lines = aiResponse.split(/\n/);
          if (lines.length > 10) {
            // If more than 10 lines, take first 10 good lines
            let goodLines = [];
            for (let line of lines) {
              line = line.trim();
              if (line.length > 5 && line.length < 500 && 
                  !line.toLowerCase().includes('calcuttonia') &&
                  !line.toLowerCase().includes('hindi language country')) {
                goodLines.push(line);
                if (goodLines.length >= 10) break;
              }
            }
            if (goodLines.length > 0) {
              aiResponse = goodLines.join('\n');
            }
          }
          
          // If response is clearly nonsensical or empty, show error
          if (aiResponse.length < 5 || aiResponse.toLowerCase().includes('calcuttonia') || 
              aiResponse.toLowerCase().includes('hindi language country') ||
              aiResponse.toLowerCase().includes('new york city specifically')) {
            aiResponse = 'Sorry, the FP16 model generated an invalid response. Please try rephrasing your question.';
            console.log('%c🤖 Invalid AI Response Detected', 'background: #fed6e3; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;', 'Nonsensical output detected');
          }
          
          updateStatus('🚀 Qwen2.5 responded!');
          
        } catch (error) {
          console.error('General chat error:', error);
          aiResponse = `FP16 model error: ${error.message}. Please try again or rephrase your question.`;
          console.log('%c🤖 FP16 Generation Error', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', error);
          updateStatus('❌ FP16 model error during generation');
        }
              } else if (aiSession.type === 'openai') {
          try {
            // OpenAI API call for general chat
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${aiSession.apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: aiSession.model,
                messages: [
                  { role: 'system', content: customContexts.general.systemPrompt },
                  { role: 'user', content: customContexts.general.userTemplate.replace('{prompt}', userPrompt) }
                ],
                max_tokens: 500,
                temperature: 0.7
              })
            });
            
            if (!response.ok) {
              throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            aiResponse = data.choices[0].message.content.trim();
            updateStatus(`🚀 ${aiSession.model} responded!`);
            
          } catch (error) {
            console.error('OpenAI API error:', error);
            aiResponse = `OpenAI API error: ${error.message}. Please check your API key and try again.`;
            updateStatus('❌ OpenAI API error');
          }
        } else {
          aiResponse = 'AI is not properly initialized. Please connect an AI model.';
          updateStatus('❌ AI not available');
        }
      
      // Add AI response to chat
      addChatMessage('ai', aiResponse);
    }

    // Handle creative chat (code generation)
    async function handleCreativeChat(userPrompt) {
      updateStatus('🤖 AI is generating code...');
      
      let code = '';
      let aiResponse = '';
        
        // AI Model handling - Code generation
        if (aiSession.type === 'qwen') {
          let generationAttempts = 0;
          const maxGenerationAttempts = 3;
          let janusSuccess = false;
          
          // Strategy: Text-only generation (no vision components)
          while (!janusSuccess && generationAttempts < maxGenerationAttempts) {
            try {
              generationAttempts++;
              
              // Use custom context template
              const fullPrompt = customContexts.creative.userTemplate.replace('{prompt}', userPrompt);

              // Use proper Qwen2.5 chat format
              const messages = [
                { role: 'system', content: customContexts.creative.systemPrompt },
                { role: 'user', content: fullPrompt }
              ];
              
              // Apply chat template and tokenize
              const textInput = aiSession.tokenizer.apply_chat_template(messages, { 
                tokenize: false, 
                add_generation_prompt: true 
              });
              
              // Log the actual formatted prompt being sent to AI
              console.log('%c🔍 ACTUAL QUERY (Qwen2.5 Creative - Attempt ' + generationAttempts + ')', 'background: #a8edea; color: #333; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
              console.log('%cFormatted Prompt:', 'color: #666; font-weight: bold;', textInput);
              
              const inputs = await aiSession.tokenizer(textInput, {
                return_tensors: 'pt',
                padding: true
              });
              
              // Try with different generation parameters based on attempt
              let genParams = { 
                input_ids: inputs.input_ids,
                attention_mask: inputs.attention_mask,
                max_new_tokens: 256,
                temperature: 0.7,
                do_sample: true
              };
              
              if (generationAttempts === 2) {
                // Second attempt: More conservative parameters
                genParams.temperature = 0.5;
                genParams.max_new_tokens = 128;
              } else if (generationAttempts === 3) {
                // Third attempt: Very conservative
                genParams.temperature = 0.3;
                genParams.max_new_tokens = 64;
                genParams.do_sample = false;
              }
              
              const out = await aiSession.model.generate(genParams);
              const newTok = out.slice(null, [inputs.input_ids.dims.at(-1), null]);
              const rawCode = aiSession.tokenizer.batch_decode(newTok, { skip_special_tokens: true })[0];
              
              // Console log raw AI output
              console.log('%c🤖 RAW AI RESPONSE (Qwen2.5 Creative - Attempt ' + generationAttempts + ')', 'background: #fa709a; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;', rawCode);
              
              // Show raw AI output in chat for debugging
              addChatMessage('system', `🔍 Raw AI Output (attempt ${generationAttempts}):`, rawCode);
              
              // Clean up the response thoroughly
              code = rawCode.trim();
              
              // Remove code blocks and explanatory text
              code = code.replace(/```javascript\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```js\n?/g, '').replace(/```\n?/g, '');
              code = code.replace(/```paddle_live_code\n?/g, '').replace(/```\n?/g, '');
              
              // Remove forbidden patterns that AI keeps generating
              if (code.includes('paddle') || code.includes('while(true)') || code.includes('gradient') || 
                  code.includes('time()') || code.includes('Math.') || code.includes('speed_')) {
                console.warn('AI generated forbidden patterns, forcing template fallback');
                throw new Error('AI generated forbidden patterns (paddle, while, gradient, etc.)');
              }
              
              // ULTRA-AGGRESSIVE EXTRACTION: Force our exact pattern
              // Strategy 1: Look for t=0 followed by draw function
              let codeMatch = code.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
              if (codeMatch) {
                code = codeMatch[1];
              } else {
                // Strategy 2: Look for draw function only and prepend t=0
                codeMatch = code.match(/(draw\s*=\s*[^{]*{[\s\S]*?})/);
                if (codeMatch) {
                  code = 't=0\n' + codeMatch[1];
                } else {
                  // Strategy 3: Look for any p5.js-like function calls
                  codeMatch = code.match(/(createCanvas|background|fill|stroke|ellipse|rect|point)[\s\S]*?}/);
                  if (codeMatch) {
                    // Build a proper p5.js structure around it
                    code = `t=0\ndraw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ${codeMatch[0]}\n}`;
                  } else {
                    // Strategy 4: If nothing works, throw error to trigger template fallback
                    throw new Error('No valid p5.js pattern found in AI response');
                  }
                }
              }
              
              // Remove any remaining HTML/markdown artifacts
              code = code.replace(/<[^>]*>/g, ''); // Remove HTML tags
              code = code.replace(/&[a-zA-Z0-9#]+;/g, ''); // Remove HTML entities
              
              // AGGRESSIVE TEXT REMOVAL: Remove explanatory sentences
              const lines = code.split('\n');
              const codeLines = [];
              let inCodeBlock = false;
              
              for (let line of lines) {
                const trimmed = line.trim();
                
                // Start of code block
                if (trimmed.startsWith('t=') || trimmed.startsWith('draw=')) {
                  inCodeBlock = true;
                }
                
                // Skip explanatory text
                if (!inCodeBlock) continue;
                
                // Skip lines that look like explanations
                if (trimmed && 
                    !trimmed.startsWith('//') &&
                    !trimmed.startsWith('*') &&
                    !trimmed.startsWith('#') &&
                    !trimmed.match(/^\d+\.?\s/) && // Skip numbered lists
                    !trimmed.toLowerCase().includes('this example') &&
                    !trimmed.toLowerCase().includes('to further') &&
                    !trimmed.toLowerCase().includes('note:') &&
                    !trimmed.toLowerCase().includes('represents') &&
                    !trimmed.toLowerCase().includes('defines what') &&
                    !trimmed.toLowerCase().includes('we keep track') &&
                    !trimmed.toLowerCase().includes('assumes all') &&
                    !trimmed.toLowerCase().includes('elaborat') &&
                    !/^(the|this|you|we|i|it|here|above|below)\s+/i.test(trimmed) &&
                    (trimmed.includes('=') || trimmed.includes('{') || trimmed.includes('}') || 
                     trimmed.includes('(') || trimmed.includes('for') || trimmed.includes('if'))) {
                  codeLines.push(line);
                }
                
                // End of code block
                if (trimmed === '}' && inCodeBlock) {
                  break;
                }
              }
              
              code = codeLines.join('\n').trim();
              
              // Final validation: ensure we have proper p5.js structure
              if (!code || code.length < 10) {
                addChatMessage('system', `⚠️ Extracted code too short: "${code}"`);
                throw new Error('No valid JavaScript code extracted from AI response');
              }
              
              // Force proper p5.js format if missing key components
              if (!code.includes('t=0')) {
                code = 't=0\n' + code;
              }
              if (!code.includes('draw=')) {
                code = code.replace(/^/, 'draw=_=>{\n  t||createCanvas(w=800,h=600)\n  background(0,20)\n  t+=0.05\n  ') + '\n}';
              }
              if (!code.includes('createCanvas')) {
                code = code.replace('draw=_=>{', 'draw=_=>{\n  t||createCanvas(w=800,h=600)');
              }
              
              // Show cleaned code before validation
              console.log('Cleaned Code:', code);
              addChatMessage('system', `🧹 Cleaned Code:`, code);
              
              // Validate code syntax before using
              try {
                new Function(code);
                console.log('✅ Code syntax validation passed');
              } catch (syntaxError) {
                console.error('❌ Syntax Error Details:', syntaxError);
                console.error('❌ Problematic Code:', code);
                console.warn('Generated code has syntax errors, using template instead');
                
                // Show detailed error info in chat
                addChatMessage('system', `❌ Syntax Error: ${syntaxError.message}`);
                addChatMessage('system', `🐛 Problematic Code: "${code.substring(0, 100)}${code.length > 100 ? '...' : ''}"`);
                addChatMessage('system', `❌ FP16 model generated invalid syntax. No fallbacks available.`);
                
                // FP16-only: No fallbacks, show error
                code = '';
                aiResponse = `FP16 model generated invalid syntax: ${syntaxError.message}. Please try a different prompt.`;
                console.log('%c🤖 FP16 Syntax Error - No Fallback', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', syntaxError);
                updateStatus('❌ FP16 generated invalid syntax - no fallbacks available');
                janusSuccess = true; // Stop retrying
                break;
              }
              aiResponse = `I've created a custom p5.js animation for "${userPrompt}" using Qwen2.5-0.5B (attempt ${generationAttempts}). Pure text model with no vision components.`;
              updateStatus(`🚀 Qwen2.5-0.5B generated code (attempt ${generationAttempts})!`);
              janusSuccess = true;
              
            } catch (janusError) {
              console.error(`Janus generation attempt ${generationAttempts} failed:`, janusError);
              
              // If this is the last attempt, provide detailed error feedback
              if (generationAttempts >= maxGenerationAttempts) {
                // Provide specific feedback for different error types
                let errorMessage = janusError.message;
                if (errorMessage.includes('WebGPU') && errorMessage.includes('Unsupported data type')) {
                  errorMessage = 'WebGPU compatibility issue with model data types';
                } else if (errorMessage.includes('ReduceMean')) {
                  errorMessage = 'ONNX runtime execution error';
                } else if (errorMessage.includes('Float16Array')) {
                  errorMessage = 'Browser lacks Float16Array support';
                } else if (errorMessage.includes('float16 tensor')) {
                  errorMessage = 'Float16 data type not supported';
                } else if (errorMessage.includes('out of memory')) {
                  errorMessage = 'Insufficient memory for model execution';
                }
                
                // FP16-only: No fallbacks, show error
                addChatMessage('ai', `❌ Qwen2.5 FP16 failed after ${generationAttempts} attempts: ${errorMessage}. No fallbacks available.`);
                code = '';
                aiResponse = `FP16 model failed after ${generationAttempts} attempts: ${errorMessage}. Please try a different prompt or restart the AI.`;
                console.log('%c🤖 FP16 Final Failure - No Fallback', 'background: #ffcccc; color: #cc0000; padding: 4px 8px; border-radius: 4px; font-weight: bold;', errorMessage);
                updateStatus('❌ FP16 failed all attempts - no fallbacks available');
                break;
              } else {
                // Try again with different parameters
                addChatMessage('system', `⚠️ Qwen2.5 attempt ${generationAttempts} failed, trying again with different parameters...`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Brief pause
              }
            }
          }
        } else if (aiSession.type === 'openai') {
          try {
            // OpenAI API call for creative coding
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${aiSession.apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: aiSession.model,
                messages: [
                  { role: 'system', content: customContexts.creative.systemPrompt },
                  { role: 'user', content: customContexts.creative.userTemplate.replace('{prompt}', userPrompt) }
                ],
                max_tokens: 800,
                temperature: 0.7
              })
            });
            
            if (!response.ok) {
              throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            const rawCode = data.choices[0].message.content.trim();
            
            // Extract p5.js code from API response
            code = rawCode.replace(/```javascript\n?/g, '').replace(/```\n?/g, '');
            code = code.replace(/```js\n?/g, '').replace(/```\n?/g, '');
            
            // Try to extract just the code if there's explanatory text
            const codeMatch = code.match(/(t\s*=\s*0[\s\S]*?draw\s*=\s*[^{]*{[\s\S]*?})/);
            if (codeMatch) {
              code = codeMatch[1];
            }
            
            aiResponse = `I've created a p5.js animation for "${userPrompt}" using ${aiSession.model}. Advanced AI model with superior code generation!`;
            updateStatus(`🚀 ${aiSession.model} generated code!`);
            
          } catch (error) {
            console.error('OpenAI API error:', error);
            code = '';
            aiResponse = `OpenAI API error: ${error.message}. Please check your API key and try again.`;
            updateStatus('❌ OpenAI API error');
          }
        } else {
          // aiSession is not valid
          code = '';
          aiResponse = 'AI is not properly initialized. Please connect an AI model.';
          updateStatus('❌ AI not available');
        }
        
        if (code.length > 10) {
          editorInstance.setValue(code);
          
          // Execute the code safely
          try {
            window.runSketch(code);
            updateStatus('✅ Code generated and executed successfully!');
          } catch (runError) {
            console.error('Error running generated code:', runError);
            updateStatus('⚠️ Code generated but execution failed. Check the code editor.');
            addChatMessage('ai', `⚠️ Generated code but execution failed: ${runError.message}. You can still edit and run it manually.`);
          }
          
          // Add AI response to chat with code preview
          const codePreview = code.split('\n').slice(0, 3).join('\n') + (code.split('\n').length > 3 ? '\n...' : '');
          addChatMessage('ai', aiResponse, codePreview);
          
        } else {
          addChatMessage('ai', 'Sorry, I couldn\'t generate valid code for that prompt. Could you try describing it differently?');
          updateStatus('❌ Generated invalid code. Try a different prompt.');
        }
    }

    // Smart Template System - Pattern-based code generation
    function generateTemplateCode(prompt) {
      const lower = prompt.toLowerCase();
      
      // Particle systems & explosions
      if (lower.includes('particle') || lower.includes('explosion') || lower.includes('dots') || lower.includes('stars')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.02
  for(i=0;i<300;i++){
    x=w/2+sin(t+i*0.1)*i*2
    y=h/2+cos(t+i*0.1)*i*2
    fill(sin(i)*127+128,cos(i)*127+128,255,200)
    ellipse(x,y,5,5)
  }
}`;
      }
      
      // Spirals & galaxies
      if (lower.includes('spiral') || lower.includes('galaxy') || lower.includes('swirl') || lower.includes('twist')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.03
  for(i=0;i<150;i++){
    a=t+i*0.3
    r=i*4
    x=w/2+cos(a)*r
    y=h/2+sin(a)*r
    fill(sin(a)*127+128,cos(a+1)*127+128,255)
    ellipse(x,y,8,8)
  }
}`;
      }
      
      // Waves & ocean
      if (lower.includes('wave') || lower.includes('ocean') || lower.includes('water') || lower.includes('sine')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,50)
  t+=0.1
  for(i=0;i<w;i+=8){
    y=h/2+sin(i*0.02+t)*80
    fill(0,150,255,180)
    ellipse(i,y,12,12)
  }
}`;
      }
      
      // Geometric patterns
      if (lower.includes('geometric') || lower.includes('triangle') || lower.includes('square') || lower.includes('polygon')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,40)
  t+=0.04
  for(i=0;i<10;i++)for(j=0;j<8;j++){
    x=i*80+40
    y=j*75+40
    fill(sin(t+i+j)*127+128,cos(t+i-j)*127+128,255)
    ellipse(x+sin(t)*20,y+cos(t)*20,30,30)
  }
}`;
      }
      
      // Kaleidoscope
      if (lower.includes('kaleidoscope') || lower.includes('mandala') || lower.includes('symmetry')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.05
  for(i=0;i<12;i++){
    a=i*PI/6+t
    x=w/2+cos(a)*200
    y=h/2+sin(a)*200
    fill(sin(a+t)*127+128,cos(a+t)*127+128,255)
    for(j=0;j<5;j++){
      ellipse(x+cos(a+j)*j*10,y+sin(a+j)*j*10,15,15)
    }
  }
}`;
      }
      
      // Colorful/rainbow
      if (lower.includes('colorful') || lower.includes('rainbow') || lower.includes('color')) {
        return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.06
  for(i=0;i<100;i++){
    x=w/2+sin(t+i*0.2)*i*3
    y=h/2+cos(t+i*0.2)*i*3
    fill(sin(i+t)*127+128,cos(i+t*2)*127+128,sin(i+t*3)*127+128)
    ellipse(x,y,10,10)
  }
}`;
      }
      
      // Default creative pattern
      return `t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,30)
  t+=0.04
  for(i=0;i<80;i++){
    x=w/2+sin(t+i*0.1)*i*2.5
    y=h/2+cos(t+i*0.15)*i*2.5
    fill(sin(t+i)*127+128,cos(t+i*0.5)*127+128,255)
    ellipse(x,y,8,8)
  }
}`;
    }

    // Generate general responses for template mode
    function generateGeneralResponse(prompt) {
      const lower = prompt.toLowerCase();
      
      // Programming/coding questions
      if (lower.includes('programming') || lower.includes('coding') || lower.includes('javascript') || lower.includes('p5.js')) {
        return "I'd be happy to help with programming questions! For p5.js specifically, try switching to Creative Mode to generate visual code. For general programming concepts, I can explain algorithms, data structures, best practices, and more.";
      }
      
      // AI/ML questions
      if (lower.includes('ai') || lower.includes('machine learning') || lower.includes('neural network') || lower.includes('artificial intelligence')) {
        return "AI and machine learning are fascinating fields! Neural networks are computational models inspired by biological brains, using layers of interconnected nodes to learn patterns from data. They're used in everything from image recognition to natural language processing like this conversation!";
      }
      
      // Technology questions
      if (lower.includes('technology') || lower.includes('computer') || lower.includes('software') || lower.includes('hardware')) {
        return "Technology is constantly evolving! I can discuss various topics like software development, computer hardware, emerging technologies, programming languages, frameworks, and how different systems work together.";
      }
      
      // Creative questions
      if (lower.includes('creative') || lower.includes('art') || lower.includes('design') || lower.includes('visual')) {
        return "Creativity and art are wonderful topics! Digital art, generative design, creative coding, and visual aesthetics all play important roles in modern creative expression. Tools like p5.js make it easy to create interactive art and animations.";
      }
      
      // Science questions
      if (lower.includes('science') || lower.includes('physics') || lower.includes('math') || lower.includes('mathematics')) {
        return "Science and mathematics form the foundation of our understanding of the world! From basic principles to complex theories, these fields help us model reality and solve problems. What specific area interests you?";
      }
      
      // Geography/world knowledge
      if (lower.includes('capital') && lower.includes('india')) {
        return "The capital of India is New Delhi.";
      }
      if (lower.includes('capital') && lower.includes('france')) {
        return "The capital of France is Paris.";
      }
      if (lower.includes('capital') && lower.includes('japan')) {
        return "The capital of Japan is Tokyo.";
      }
      if (lower.includes('capital') && lower.includes('uk') || lower.includes('united kingdom') || lower.includes('england')) {
        return "The capital of the United Kingdom is London.";
      }
      
      // General greeting/help
      if (lower.includes('hello') || lower.includes('hi') || lower.includes('help') || lower.includes('what can you do')) {
        return "Hello! I'm your AI assistant. In General Chat mode, I can discuss various topics like technology, science, programming, art, and more. Switch to Creative Mode if you want to generate p5.js visual art code. What would you like to talk about?";
      }
      
      // Default response
      return `That's an interesting question about "${prompt}"! I can discuss a wide range of topics including technology, science, programming, art, and general knowledge. Feel free to ask me anything specific you'd like to know more about.`;
    }

    function updateStatus(message) {
      document.getElementById('statusBar').textContent = message;
      setTimeout(() => {
        document.getElementById('statusBar').textContent = 'Ready to create amazing p5.js art! 🚀';
      }, 3000);
    }

    // Chat Functions
    function addChatMessage(type, content, codePreview = null) {
      const chatHistoryEl = document.getElementById('chatHistory');
      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${type}`;
      
      let headerText = '';
      switch(type) {
        case 'user': headerText = '👤 You'; break;
        case 'ai': 
          if (aiSession === 'template') {
            headerText = '🤖 Smart Templates';
          } else if (aiSession.type === 'qwen') {
            headerText = '🧠 Qwen2.5-0.5B';
          } else {
            headerText = '🤖 AI Assistant';
          }
          break;
        case 'system': headerText = '⚙️ System'; break;
      }
      
      messageEl.innerHTML = `
        <div class="message-header">${headerText}</div>
        <div>${content}</div>
        ${codePreview ? `<div class="code-preview">${codePreview}</div>` : ''}
      `;
      
      chatHistoryEl.appendChild(messageEl);
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      
      // Store in history
      chatHistory.push({ type, content, codePreview, timestamp: Date.now() });
    }

    // AI Panel Functions
    function toggleAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      if (panel.classList.contains('hidden')) {
        panel.classList.remove('hidden');
        toggleBtn.classList.add('active');
      } else {
        panel.classList.add('hidden');
        toggleBtn.classList.remove('active');
      }
    }

    function minimizeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const content = document.getElementById('aiContent');
      
      if (panel.classList.contains('minimized')) {
        panel.classList.remove('minimized');
        content.classList.remove('minimized');
      } else {
        panel.classList.add('minimized');
        content.classList.add('minimized');
      }
    }

    function closeAIPanel() {
      const panel = document.getElementById('aiFloatingPanel');
      const toggleBtn = document.getElementById('aiToggleBtn');
      
      panel.classList.add('hidden');
      toggleBtn.classList.remove('active');
    }

    // Toggle between Creative and General chat modes
    function toggleChatMode() {
      const modeBtn = document.getElementById('chatModeBtn');
      const promptInput = document.getElementById('aiPrompt');
      
      if (chatMode === 'creative') {
        chatMode = 'general';
        modeBtn.textContent = '💬 General Chat';
        modeBtn.style.background = 'linear-gradient(45deg, #a8edea 0%, #fed6e3 100%)';
        promptInput.placeholder = 'Ask me anything... e.g., "Explain how neural networks work" or "What is the weather like?"';
        addChatMessage('system', '💬 Switched to General Chat mode. You can now ask any questions without p5.js code generation.');
      } else {
        chatMode = 'creative';
        modeBtn.textContent = '🎨 Creative Mode';
        modeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        promptInput.placeholder = 'Describe what you want to create... e.g., "colorful spinning triangles" or "particle system with gravity"';
        addChatMessage('system', '🎨 Switched to Creative Coding mode. Describe visual patterns to generate p5.js code.');
      }
    }

    // Show Context Editor Modal
    function showContextEditor() {
      const modal = document.createElement('div');
      modal.className = 'context-editor-modal';
      modal.id = 'contextEditorModal';
      
      modal.innerHTML = `
        <div class="context-editor-content">
          <div class="context-editor-header">
            <h2>⚙️ Context Editor</h2>
            <button class="context-btn secondary" onclick="closeContextEditor()">×</button>
          </div>
          
          <div class="model-selector">
            <label style="color: rgba(255,255,255,0.8); font-weight: 600;">Model:</label>
            <select id="modelSelect">
              <option value="qwen">Qwen2.5-0.5B FP16</option>
            </select>
          </div>
          
          <div class="context-sections">
            <div class="context-section">
              <h3>💬 General Chat Context</h3>
              
              <div class="context-input-group">
                <label>System Prompt:</label>
                <textarea id="generalSystemPrompt" class="context-textarea" placeholder="Define the AI's role and behavior for general conversations...">${customContexts.general.systemPrompt}</textarea>
                <div class="context-template-hint">Sets the AI's personality and behavior for general questions</div>
              </div>
              
              <div class="context-input-group">
                <label>User Message Template:</label>
                <textarea id="generalUserTemplate" class="context-textarea large" placeholder="Template for user messages... Use {prompt} as placeholder">${customContexts.general.userTemplate}</textarea>
                <div class="context-template-hint">Use {prompt} where user input should be inserted</div>
              </div>
            </div>
            
            <div class="context-section">
              <h3>🎨 Creative Chat Context</h3>
              
              <div class="context-input-group">
                <label>System Prompt:</label>
                <textarea id="creativeSystemPrompt" class="context-textarea" placeholder="Define the AI's role for code generation...">${customContexts.creative.systemPrompt}</textarea>
                <div class="context-template-hint">Sets the AI's behavior for p5.js code generation</div>
              </div>
              
              <div class="context-input-group">
                <label>User Message Template:</label>
                <textarea id="creativeUserTemplate" class="context-textarea large" placeholder="Template for creative prompts... Use {prompt} as placeholder">${customContexts.creative.userTemplate}</textarea>
                <div class="context-template-hint">Include instructions and examples for p5.js code generation</div>
              </div>
            </div>
          </div>
          
          <div class="context-editor-actions">
            <div>
              <button class="context-btn secondary" onclick="resetContexts()">🔄 Reset to Defaults</button>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="context-btn secondary" onclick="closeContextEditor()">Cancel</button>
              <button class="context-btn primary" onclick="saveContexts()">💾 Save & Apply</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Close Context Editor
    function closeContextEditor() {
      const modal = document.getElementById('contextEditorModal');
      if (modal) {
        modal.style.opacity = '0';
        modal.style.transform = 'scale(0.9)';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        }, 200);
      }
    }

    // Save custom contexts
    function saveContexts() {
      const generalSystem = document.getElementById('generalSystemPrompt').value.trim();
      const generalUser = document.getElementById('generalUserTemplate').value.trim();
      const creativeSystem = document.getElementById('creativeSystemPrompt').value.trim();
      const creativeUser = document.getElementById('creativeUserTemplate').value.trim();
      
      // Validate inputs
      if (!generalSystem || !generalUser || !creativeSystem || !creativeUser) {
        alert('All fields are required. Please fill in all context templates.');
        return;
      }
      
      if (!generalUser.includes('{prompt}') || !creativeUser.includes('{prompt}')) {
        alert('User templates must contain {prompt} placeholder for user input.');
        return;
      }
      
      // Save to custom contexts
      customContexts.general.systemPrompt = generalSystem;
      customContexts.general.userTemplate = generalUser;
      customContexts.creative.systemPrompt = creativeSystem;
      customContexts.creative.userTemplate = creativeUser;
      
      closeContextEditor();
      addChatMessage('system', '✅ Custom contexts saved and applied! Your chat templates are now active for this session.');
      updateStatus('✅ Custom contexts applied successfully!');
      
      // Track context customization
      if (window.AppConfig) {
        window.AppConfig.trackEvent('context_customized', 'ai_interaction', 'custom_templates');
      }
    }

    // Reset contexts to defaults
    function resetContexts() {
      if (confirm('Reset all contexts to default values? This will overwrite your current changes.')) {
        // Reset to original defaults
        document.getElementById('generalSystemPrompt').value = 'You are a helpful AI assistant. Answer questions clearly and informatively.';
        document.getElementById('generalUserTemplate').value = 'Question: {prompt}\n\nAnswer this question clearly and informatively (maximum 10 lines). Be direct and helpful.';
        document.getElementById('creativeSystemPrompt').value = 'You are a helpful assistant that generates p5.js code.';
        document.getElementById('creativeUserTemplate').value = `Generate p5.js code for: {prompt}

Use this exact structure:
t=0
draw=_=>{
  t||createCanvas(w=800,h=600)
  background(0,20)
  t+=0.05
  fill(255,100,150)
  ellipse(400+sin(t)*100,300+cos(t)*100,50,50)
}

Only modify the fill() and ellipse() lines to create the requested animation. Return just the 6-line code block.`;
      }
    }

    // Editor expand/minimize functions
    function expandEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const canvasContainer = document.querySelector('.canvas-container');
      const expandBtn = document.getElementById('expandEditorBtn');
      
      if (editorContainer.classList.contains('expanded')) {
        // Restore normal view
        editorContainer.classList.remove('expanded');
        canvasContainer.classList.remove('hidden');
        expandBtn.textContent = '⤢';
        expandBtn.title = 'Expand Editor';
        updateStatus('📝 Editor restored to normal view');
      } else {
        // Expand editor
        editorContainer.classList.add('expanded');
        canvasContainer.classList.add('hidden');
        expandBtn.textContent = '⤡';
        expandBtn.title = 'Restore Editor';
        updateStatus('📝 Editor expanded for full-screen coding');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    function minimizeEditor() {
      const editorContainer = document.getElementById('editorContainer');
      const minimizeBtn = document.getElementById('minimizeEditorBtn');
      
      if (editorContainer.classList.contains('minimized')) {
        // Restore editor
        editorContainer.classList.remove('minimized');
        minimizeBtn.textContent = '−';
        minimizeBtn.title = 'Minimize Editor';
        updateStatus('📝 Editor restored');
      } else {
        // Minimize editor
        editorContainer.classList.add('minimized');
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Restore Editor';
        updateStatus('📝 Editor minimized');
      }
      
      // Trigger Monaco editor resize
      setTimeout(() => {
        if (editorInstance) {
          editorInstance.layout();
        }
      }, 300);
    }

    // Runner: execute user code in p5 context (Global scope)
    window.runSketch = function(src) {
      if (currentP5) currentP5.remove();

      try {
        updateStatus('🎨 Running your code...');
        
        // Create p5 instance and execute the user's code
        currentP5 = new p5((p) => {
          
          // Make p5 functions available in global scope for user code
          const p5Functions = ['createCanvas', 'background', 'stroke', 'point', 'sin', 'cos', 'mag', 'noise', 'noFill', 'arc', 'fill', 'noStroke', 'strokeWeight', 'ellipse', 'rect', 'line', 'triangle', 'quad', 'bezier', 'curve', 'random'];
          
          p5Functions.forEach(fn => {
            if (p[fn]) {
              window[fn] = p[fn].bind(p);
            }
          });
          
          // Constants
          window.PI = p.PI;
          window.TWO_PI = p.TWO_PI;
          window.HALF_PI = p.HALF_PI;
          window.PIE = p.PIE;
          window.CHORD = p.CHORD;
          window.OPEN = p.OPEN;
          
          // Common variables
          window.w = 400;
          window.W = 720;
          
          try {
            // Execute user code directly
            eval(src);
            
            // If draw function was created globally, use it
            if (window.draw && typeof window.draw === 'function') {
              p.draw = window.draw;
              updateStatus('✅ Code executed successfully!');
            }
            
          } catch (evalError) {
            console.error('Error executing user code:', evalError);
            updateStatus('❌ Code error: ' + evalError.message);
            // Fallback to a simple sketch
            p.setup = function() {
              p.createCanvas(400, 400);
              p.background(50);
            };
            p.draw = function() {
              p.stroke(255);
              p.text('Code Error: Check Console', 10, 20);
            };
          }
          
        }, 'canvas');
        
      } catch (error) {
        console.error('Error running sketch:', error);
        updateStatus('❌ Failed to run sketch');
      }
    };

    require(['vs/editor/editor.main'], () => {
      // Initialize Monaco with default fish code
      editorInstance = monaco.editor.create(
        document.getElementById('editor'), {
          value: [
            '// Welcome to SketchPad-SLM!',
            '// Edit this code and click "Draw" to see magic happen ✨',
            '',
            '// Fish animation scaled to full canvas size',
            'a=(x,y,d=mag(k=(4+cos(y))*cos(x/4),e=y/8-20))=>point((q=sin(k*3)+sin(y/19+9)*k*(6+sin(e*14-d)))*cos(d/8+t/4)+50*cos(c=d-t)+w/2,q*sin(c)+d*7*sin(c/4)+h/2)',
            't=0,draw=$=>{if(!t){w=800;h=600;createCanvas(w,h)}background(9);stroke(255,116);for(t+=PI/120,i=1e4;i--;)a(i,i/235)}'
          ].join('\n'),
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          fontSize: 14,
          minimap: { enabled: false },
          scrollBeyondLastLine: false,
          wordWrap: 'on'
      });

      // Load design from lib/Designs folder
      async function loadDesign(designName) {
        if (!designName) return;
        
        try {
          updateStatus(`📁 Loading ${designName}...`);
          const response = await fetch(designs[designName]);
          if (response.ok) {
            const code = await response.text();
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`✅ Loaded ${designName} successfully!`);
          } else {
            updateStatus(`❌ Failed to load ${designName}`);
          }
        } catch (error) {
          console.error('Error loading design:', error);
          updateStatus(`❌ Error loading ${designName}`);
        }
      }

      // Event Listeners
      document.getElementById('runBtn').addEventListener('click', () => {
        // Track code execution
        if (window.AppConfig) {
          window.AppConfig.trackEvent('code_executed', 'user_interaction', 'run_button');
        }
        window.runSketch(editorInstance.getValue());
      });

      document.getElementById('designSelect').addEventListener('change', (e) => {
        // Track design selection
        if (window.AppConfig && e.target.value) {
          window.AppConfig.trackEvent('design_loaded', 'user_interaction', e.target.value);
        }
        loadDesign(e.target.value);
      });

      document.getElementById('loadFileBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.name.endsWith('.js')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const code = e.target.result;
            editorInstance.setValue(code);
            window.runSketch(code);
            updateStatus(`✅ Loaded ${file.name}`);
          };
          reader.readAsText(file);
        } else {
          updateStatus('❌ Please select a .js file');
        }
      });

      document.getElementById('saveFileBtn').addEventListener('click', () => {
        const code = editorInstance.getValue();
        const blob = new Blob([code], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sketch_${Date.now()}.js`;
        a.click();
        URL.revokeObjectURL(url);
        updateStatus('💾 File saved successfully!');
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (currentP5) {
          currentP5.remove();
          currentP5 = null;
          updateStatus('🗑️ Canvas cleared');
        }
      });

      document.getElementById('resetBtn').addEventListener('click', () => {
        editorInstance.setValue([
          '// Welcome to SketchPad-SLM!',
          '// Edit this code and click "Draw" to see magic happen ✨',
          '',
          't=0',
          'draw=_=>{',
          '  t||createCanvas(400,400)',
          '  background(0)',
          '  t+=0.05',
          '  ',
          '  // Your creative code here!',
          '  fill(sin(t)*127+128,cos(t)*127+128,255)',
          '  ellipse(200+sin(t)*100,200+cos(t)*100,50,50)',
          '}'
        ].join('\n'));
        updateStatus('🔄 Code reset to template');
      });

      // AI Event Listeners
      document.getElementById('initAIBtn').addEventListener('click', () => {
        // Track AI initialization
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_init_clicked', 'ai_interaction', 'init_button');
        }
        initializeAI();
      });
      
      document.getElementById('chatModeBtn').addEventListener('click', () => {
        // Track chat mode toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('chat_mode_toggled', 'ai_interaction', chatMode);
        }
        toggleChatMode();
      });
      
      document.getElementById('contextBtn').addEventListener('click', () => {
        // Track context editor open
        if (window.AppConfig) {
          window.AppConfig.trackEvent('context_editor_opened', 'ai_interaction', 'context_button');
        }
        showContextEditor();
      });
      
      document.getElementById('generateBtn').addEventListener('click', () => {
        // Check if user has accepted agreement first
        if (!userAgreementAccepted) {
          showUserAgreement();
          return;
        }
        
        const prompt = document.getElementById('aiPrompt').value.trim();
        if (prompt) {
          // Track AI code generation
          if (window.AppConfig) {
            window.AppConfig.trackEvent('ai_code_generated', 'ai_interaction', chatMode, prompt.length);
          }
          generateAICode(prompt);
        } else {
          updateStatus('❌ Please enter a prompt first');
        }
      });

      // Allow Enter key in prompt textarea to generate
      document.getElementById('aiPrompt').addEventListener('keydown', (e) => {
        // Enter (without Shift) generates code
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault(); // Prevent new line
          const prompt = e.target.value.trim();
          if (prompt && !document.getElementById('generateBtn').disabled) {
            generateAICode(prompt);
            // Clear the input after generating
            setTimeout(() => {
              e.target.value = '';
            }, 100);
          }
        }
        // Shift+Enter allows new lines for multi-line prompts
      });

      // AI Panel event listeners
      document.getElementById('aiToggleBtn').addEventListener('click', () => {
        // Track AI panel toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_toggled', 'ui_interaction', 'toggle_button');
        }
        toggleAIPanel();
      });
      
      document.getElementById('minimizeBtn').addEventListener('click', () => {
        // Track AI panel minimize
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_minimized', 'ui_interaction', 'minimize_button');
        }
        minimizeAIPanel();
      });
      
      document.getElementById('closeBtn').addEventListener('click', () => {
        // Track AI panel close
        if (window.AppConfig) {
          window.AppConfig.trackEvent('ai_panel_closed', 'ui_interaction', 'close_button');
        }
        closeAIPanel();
      });

      // Editor control event listeners
      document.getElementById('expandEditorBtn').addEventListener('click', expandEditor);
      document.getElementById('minimizeEditorBtn').addEventListener('click', minimizeEditor);
      
      // Copy code button
      document.getElementById('copyCodeBtn').addEventListener('click', () => {
        const copyBtn = document.getElementById('copyCodeBtn');
        const originalText = copyBtn.textContent;
        const originalTitle = copyBtn.title;
        
        const code = editorInstance.getValue();
        navigator.clipboard.writeText(code).then(() => {
          // Show success feedback
          copyBtn.textContent = '✅';
          copyBtn.title = 'Code Copied!';
          copyBtn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
          copyBtn.style.transform = 'scale(1.1)';
          updateStatus('📄 Code copied to clipboard successfully!');
          
          // Restore original button after 2 seconds
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.title = originalTitle;
            copyBtn.style.background = '';
            copyBtn.style.transform = '';
          }, 2000);
          
        }).catch(err => {
          console.error('Failed to copy code:', err);
          // Show error feedback
          copyBtn.textContent = '❌';
          copyBtn.title = 'Copy Failed!';
          copyBtn.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
          updateStatus('❌ Failed to copy code to clipboard');
          
          // Restore original button after 2 seconds
          setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.title = originalTitle;
            copyBtn.style.background = '';
          }, 2000);
        });
      });
      
      // API mode toggle
      document.getElementById('apiModeToggle').addEventListener('change', (e) => {
        apiMode = e.target.checked;
        const apiKeySection = document.getElementById('apiKeySection');
        
        if (apiMode) {
          apiKeySection.style.display = 'block';
          document.getElementById('initAIBtn').textContent = '🚀 Connect API';
          updateStatus('🔑 API mode enabled. Enter your OpenAI API key.');
        } else {
          apiKeySection.style.display = 'none';
          document.getElementById('initAIBtn').textContent = '🔌 Connect';
          updateStatus('🤖 Local mode enabled. Use FP16 Qwen2.5.');
        }
        
        // Reset AI session when switching modes
        aiSession = null;
        document.getElementById('aiStatus').textContent = 'AI: Not connected';
        document.getElementById('generateBtn').disabled = true;
        
        // Track mode toggle
        if (window.AppConfig) {
          window.AppConfig.trackEvent('api_mode_toggled', 'ai_interaction', apiMode ? 'api' : 'local');
        }
      });
      
      // API key visibility toggle
      document.getElementById('toggleApiKeyVisibility').addEventListener('click', () => {
        const apiKeyInput = document.getElementById('openaiApiKey');
        const toggleBtn = document.getElementById('toggleApiKeyVisibility');
        
        if (apiKeyInput.type === 'password') {
          apiKeyInput.type = 'text';
          toggleBtn.textContent = '🙈';
          toggleBtn.title = 'Hide API Key';
        } else {
          apiKeyInput.type = 'password';
          toggleBtn.textContent = '👁️';
          toggleBtn.title = 'Show API Key';
        }
      });
      
      // Agreement status button
      document.getElementById('agreementStatusBtn').addEventListener('click', () => {
        showAgreementFromStatus();
      });

      // Auto-run fish animation on load
      setTimeout(() => {
        window.runSketch(editorInstance.getValue());
      }, 1000);

      // Initialize agreement status display
      updateAgreementStatusDisplay();
      
      // Start agreement reminder system
      startAgreementReminders();

      updateStatus('🚀 SketchPad-SLM loaded successfully!');
    });
  </script>
</body>
</html>
