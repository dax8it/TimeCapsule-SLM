version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "üì¶ Installing dependencies..."
        - npm ci
        - echo "üîß Node.js version:"
        - node --version
        - echo "üì¶ npm version:"
        - npm --version
        - echo "üåç Environment variables check..."
        - echo "NEXT_PUBLIC_GA4_MEASUREMENT_ID is ${NEXT_PUBLIC_GA4_MEASUREMENT_ID:-'not set'}"
        - echo "NEXT_PUBLIC_SITE_NAME is ${NEXT_PUBLIC_SITE_NAME:-'not set'}"
        - echo "NEXT_PUBLIC_SITE_URL is ${NEXT_PUBLIC_SITE_URL:-'not set'}"
        - echo "GA4_ANONYMIZE_IP is ${GA4_ANONYMIZE_IP:-'not set'}"
        - echo "GA4_DEBUG_MODE is ${GA4_DEBUG_MODE:-'not set'}"
        - echo "üîê Authentication variables check..."
        - echo "AUTH_SECRET is ${AUTH_SECRET:+set}"
        - echo "AUTH_GITHUB_ID is ${AUTH_GITHUB_ID:+set}"
        - echo "AUTH_GITHUB_SECRET is ${AUTH_GITHUB_SECRET:+set}"
        - echo "AUTH_GOOGLE_ID is ${AUTH_GOOGLE_ID:+set}"
        - echo "AUTH_GOOGLE_SECRET is ${AUTH_GOOGLE_SECRET:+set}"
    build:
      commands:
        - echo "üî® Building Next.js application..."
        - echo "üåç Final environment variables verification:"
        - echo "NEXT_PUBLIC_GA4_MEASUREMENT_ID=$NEXT_PUBLIC_GA4_MEASUREMENT_ID"
        - echo "NEXT_PUBLIC_SITE_NAME=$NEXT_PUBLIC_SITE_NAME"
        - echo "NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL"
        - echo "GA4_ANONYMIZE_IP=$GA4_ANONYMIZE_IP"
        - echo "GA4_DEBUG_MODE=$GA4_DEBUG_MODE"
        - echo "üîê VERBOSE Authentication Variables Debug:"
        - echo "================================================"
        - 'echo "AUTH_SECRET length: ${#AUTH_SECRET} chars"'
        - 'echo "AUTH_SECRET value: ${AUTH_SECRET}"'
        - echo "------------------------------------------------"
        - 'echo "AUTH_GITHUB_ID length: ${#AUTH_GITHUB_ID} chars"'
        - 'echo "AUTH_GITHUB_ID value: ${AUTH_GITHUB_ID}"'
        - echo "------------------------------------------------"
        - 'echo "AUTH_GITHUB_SECRET length: ${#AUTH_GITHUB_SECRET} chars"'
        - 'echo "AUTH_GITHUB_SECRET value: ${AUTH_GITHUB_SECRET}"'
        - echo "------------------------------------------------"
        - 'echo "AUTH_GOOGLE_ID length: ${#AUTH_GOOGLE_ID} chars"'
        - 'echo "AUTH_GOOGLE_ID value: ${AUTH_GOOGLE_ID}"'
        - echo "------------------------------------------------"
        - 'echo "AUTH_GOOGLE_SECRET length: ${#AUTH_GOOGLE_SECRET} chars"'
        - 'echo "AUTH_GOOGLE_SECRET value: ${AUTH_GOOGLE_SECRET}"'
        - echo "================================================"
        - 'echo "üåê Site URL Configuration:"'
        - 'echo "NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}"'
        - 'echo "NODE_ENV: ${NODE_ENV:-NOT_SET}"'
        - echo "================================================"
        - echo "üîç Variable Validation Checks:"
        - 'if [ -z "$AUTH_SECRET" ]; then echo "‚ùå AUTH_SECRET is empty"; else echo "‚úÖ AUTH_SECRET is set"; fi'
        - 'if [ -z "$AUTH_GITHUB_ID" ]; then echo "‚ùå AUTH_GITHUB_ID is empty"; else echo "‚úÖ AUTH_GITHUB_ID is set"; fi'
        - 'if [ -z "$AUTH_GITHUB_SECRET" ]; then echo "‚ùå AUTH_GITHUB_SECRET is empty"; else echo "‚úÖ AUTH_GITHUB_SECRET is set"; fi'
        - 'if [ -z "$AUTH_GOOGLE_ID" ]; then echo "‚ùå AUTH_GOOGLE_ID is empty"; else echo "‚úÖ AUTH_GOOGLE_ID is set"; fi'
        - 'if [ -z "$AUTH_GOOGLE_SECRET" ]; then echo "‚ùå AUTH_GOOGLE_SECRET is empty"; else echo "‚úÖ AUTH_GOOGLE_SECRET is set"; fi'
        - echo "================================================"
        - npm run build
        - echo "‚úÖ Build completed successfully!"
    postBuild:
      commands:
        - echo "üìä Post-build optimizations..."
        - echo "üîç Checking build output..."
        - ls -la .next/
        - echo "‚úÖ Build artifacts created successfully"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'X-Frame-Options'
          value: 'DENY'
        - key: 'X-XSS-Protection'
          value: '1; mode=block'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'
        - key: 'Referrer-Policy'
          value: 'strict-origin-when-cross-origin'
        - key: 'Permissions-Policy'
          value: 'camera=(), microphone=(), geolocation=()'
    - pattern: '/favicon.ico'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=86400'
    - pattern: '/Media/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable'
    - pattern: '/_next/static/**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable' 